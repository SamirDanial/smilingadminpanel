image: node:16.13.1

definitions:
  caches:
    nodeall: ./node_modules
    yarn: /usr/local/share/.cache/yarn
  steps:
    - step: &Quality-Check
        name: Code Quality Checks üéÄ
        script:
          - "yarn install"
          - "yarn run lint"
    - step: &Unit-Tests
        name: Unit Testing üî´
        script:
          - "yarn install"
          - "yarn run test"

pipelines:
  default:
    - parallel:
        - step: *Quality-Check
        - step: *Unit-Tests
  branches:
    "{master,main}":
      - step: *Quality-Check
      - step: *Unit-Tests
      - step:
          name: Deploying development üöÄ
          caches:
            - nodeall
            - yarn
          script:
            - echo 'Connecting to remote server to update repo'
            - node --version
            - npm --version
            - pipe: atlassian/ssh-run:0.4.1
              variables:
                SSH_USER: $USER
                SERVER: $SERVER_ADRESS
                COMMAND: "cd smiling-scripts && bash admin-deploy-dev.sh"
    staging:
      - step: *Quality-Check
      - step: *Unit-Tests
      - step:
          name: Deploying staging üé©
          caches:
            - nodeall
            - yarn
          script:
            - echo 'Connecting to remote server to update repo'
            - pipe: atlassian/ssh-run:0.4.1
              variables:
                SSH_USER: $USER
                SERVER: $SERVER_ADRESS
                COMMAND: "cd smiling-scripts && bash admin-deploy-staging.sh"
    prod:
      - step: *Quality-Check
      - step: *Unit-Tests
      - step:
          name: Deploying Production üê®
          caches:
            - nodeall
            - yarn
          script:
            - echo 'Connecting to remote server to update repo'
            - pipe: atlassian/ssh-run:0.4.1
              variables:
                SSH_USER: $USER
                SERVER: $SERVER_ADRESS
                COMMAND: "cd smiling-scripts && bash admin-deploy-prod.sh"
